# Скрипты для сборки образов

В buildscripts в каталогах app, jenkins и minio расположены файлы сборки образов докера. В корне каталога buildscripts расположен файл docker-compose.yaml, который выполняет сборку и настройку образов jenkins и minio.

## Хралилище данных MinIO

В качестве удаленного хранилища данных была выбрана система объектного хранения MinIO, которая совместима по API с облачным сервисом хранения Amazon S3.

Для развертывания образа MinIO необходимо создать в каталоге buildscripts/minio файл default.env со следующими переменными среды:

```env
MINIO_ROOT_USER=
MINIO_ROOT_PASSWORD=
```

Имя пользователя и значение пароля из этих переменных среды понадобятся при настройке пайплайна Jenkins.

После равертывания образа MinIO необходимо через браузер авторизоваться в панели администрирования сервиса по адресу `http://<ардес сервера с docker>:4001`. В этой панели в разделе Buckets нужно создать корзину с наименованием `mlops-files`. В этой карзине будут храниться версии датасетов и моделей.

## CI/CD Jenkins

Для развертывания Jenkins был сделан файл Dockerfile, в котором во время сборки образа устанавливаются плагины (указанные в файле plugins.txt) и Python. Собранный образ опубликован в реестре https://hub.docker.com с именем kavlab/mlops-jenkins. Для использования вне проекта можно установить этот образ командой `docker pull kavlab/mlops-jenkins`. А в этом проекте образ используется в docker compose.

Панель администрирования Jenkins доступна по адресу `http://<ардес сервера с docker>:4080`.

### Jenkins pipelines

Кроме файлов Dockerfile и plugins.txt в каталоге jenkins есть ещё два пайплайна Jenkinsfile в подкаталогах data_engineering и deployment.

Пайплайн из подкаталога data_engineering используется для загрузки датасета, обработки признаков, тестирования данных, версионирования датасета, обучения модели, тестирования модели, версионирования модели и публикации результатов в хранилище DVC и в репозиторий GitHub.

Пайплайн из подкаталога deployment используется для тестирования приложения, сборки образа и публикации образа в докере.

Для использования этих пайпланов необходимо настроить Jenkins: задать параметры авторизации в хранилище DVC и в GitHub.

Для авторизации в удаленном хранилище DVC используется логин и пароль. Поэтому в разделе Manage Jenkins > Credentials нужно добавить запись в Global credentials с идентификатором `S3` и указать логин и пароль, которые были заданы в файле default.env при развертывании MinIO.

А для авторизации на GitHub используются Deploy keys. Сгенерированнй и добавленный в репозиторий GitHub ключ нужно добавить в Global credentials с идентификатором `jenkins_ssh_github`.

## Приложение проекта

Для сборки образа приложения был сделан файл Dockerfile разсположенный в подкаталоге app.

Этот файл используется в пайплане Jenkins для автоматического развертывания приложения в докере с использованием последней версии модели из удаленного хранилища DVC.

После развертывания приложение доступно по следующему адресу: `http://<ардес сервера с docker>:4501`
